
# 2024/2/25 API
https://kfields.me/blog/pyenv_on_ubuntu_22
```
apt update -y
sudo apt-get update; sudo apt-get install make build-essential libssl-dev zlib1g-dev \
libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm \
libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev
curl https://pyenv.run | bash

echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
echo -e 'if command -v pyenv 1>/dev/null 2>&1; then\n eval "$(pyenv init -)"\nfi' >> ~/.bashrc

exec "$SHELL"

pyenv install --list
```
https://www.maxlist.xyz/2020/04/01/python-pyenv-virtualenv/

E: Unable to locate package python-openssl
`sudo apt install python3-openssl`


## Q&A
Q:虛擬機的服務有辦法連到宿主機的服務嗎？
A:其實可以，但只要能設定相對應的網路模式就能連結，但會相對麻煩，建議還是講主要服務放在主機上，次要服務放置虛擬機中，或是全部放在同一個環境中。

Q:python繼承之中, 如何取得祖父的物件？
A: `super(FatherObject, self).func()`
https://stackoverflow.com/questions/43016737/python-inheritance-how-to-call-grandparent-method
假設我有Aninmal - Dog - GoldenRetriever
在GoldenRetriever的function 中可以使用以下方式取的 Aninmal的function
```
def eat(self):
    super(Dog, self).eat()
    print("i am eating golden retriever food.")
```

Q:vscode有沒有什麼方便的快捷鍵
A:
- crtl + D: 選取相同的東西, 並能一次改掉
![image](https://hackmd.io/_uploads/BJqZWVO3a.png)
- alt + shift + 下 / 上： 複製一個該行的出來(上或下)
- ctrl + P: 快速搜尋檔案
![image](https://hackmd.io/_uploads/SkxwZ4_hp.png)
- ctrl + F: 該檔案全域搜尋
![image](https://hackmd.io/_uploads/SJy5WVuh6.png)

Q: 最有效率的string 加法
A: https://realpython.com/python-string-concatenation/
Unlike the concatenation operators, Python’s .join() doesn’t create new intermediate strings in each iteration. Instead, it creates a single new string object by joining the elements from the input iterable with the selected separator string. This behavior is more efficient than using the regular concatenation operators in a loop.
簡單來說因為每一次在 += 的過程中, 其實都會新增一個變數出來, 這樣其實會相對耗記憶體資源, 但join()他只會新建一個變數, 在做全部的加總, 所以不會有這個問題, BTW, 可以多讀[realpython](https://realpython.com/) 文章, 他都寫得很好, 而且有定期更新 [podcast](https://open.spotify.com/show/41Av6Rq81LfOT3Volz7W9D?si=5bb1ea23ac2c4298)有興趣的同學可以參考

Q: 有辦法透過google auth做為第三方的驗證機制嗎
A: https://www.tsg.com.tw/blog-detail2-162-0-google-login.htm 可以參考此方式
    [keycloak](https://www.keycloak.org/) 也可以參考這個solution


Q: hashmap 的資料結構
A: https://rickbsr.medium.com/%E6%B7%BA%E8%AB%87-hash-hashtable-%E8%88%87-hashmap-4e5f5e5d36da

Q: CS系列
A: 
- [CS61B](https://inst.eecs.berkeley.edu/~cs61b/sp22/): 資料結構與演算法-JAVA
- [CS61A](https://cs61a.org/): Python 進階用法

Q: 如何打開ubunut的防火牆
A: https://computingforgeeks.com/install-and-use-firewalld-on-ubuntu/

Q: 何時該使用`import x`, 何時該使用`from . import x`
![image](https://hackmd.io/_uploads/SJT5FwO26.png)
- 如果是在有 __init__.py的同一層裡面, 必須使用 relative import `from . import x`, 但如果沒有就用一般的import就可以了


### ==問題==
swagger-ui/:17 Uncaught ReferenceError: SwaggerUIBundle is not defined
    at swagger-ui/:17:12
(anonymous) @ swagger-ui/:17

`ALTER USER 'admin'@'localhost' IDENTIFIED BY 'password';`

多打一個 `FLUSH PRIVILEGES;`



![image](https://hackmd.io/_uploads/HkS03uO36.png)


## 有錯誤：
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'IDENTIFIED BY '1'
https://github.com/swagger-api/swagger-ui/issues/5897

## 大綱
- Python 語法說明(decorator, inheritance)
- 基本API設計(PATCH, Get single)
- 進階API設計
    - Swagger文件
    - JWT token




## 需預先下載的軟體
- [Vscode](https://code.visualstudio.com/download)
- [Postman](https://www.postman.com/downloads/)
- Python3.10
    - python-dotenv==1.0.1
    - requests==2.31.0
    - Flask-JWT-Extended==4.4.1
    - Flask==2.1.2
    - Flask-RESTful == 0.3.9
    - PyMySQL==1.0.3
    - Werkzeug==2.2.2
    - flask-apispec==0.11.4
    - marshmallow==3.18.0
    - marshmallow-enum==1.5.1
- MySQLDB server, 可以用自己習慣的方式下載, 也可以使用 [MAMP](https://www.mamp.info/en/downloads/) 來驅動

## 上課會用到網頁
- [ChatGPT](https://chat.openai.com/)
- [Jwt解析網頁](https://jwt.io/)
- [Marshmello官網](https://marshmallow.readthedocs.io/en/stable/)

## 上半堂
decorator 裝飾器

```

"""
@print_func_name
def execute():
    print("nice")

execute()
>>> The function name is execute
>>> nice
"""


## function的加工
"""

def print_func_name(func):
    print(f"The function name is {func.__name__}")
    func()


def execute():
    print("nice")


def execute2():
    print("nice2")


if __name__ == "__main__":

    execute()
    print_func_name(execute2)

"""

########################################################


## function的加工2


# def print_func_name(func):
#     def warp():
#         print(f"The function name is {func.__name__}")
#         func()

#     return warp

"""
def print_func_name(func):
    def warp():
        print(f"The function name is {func.__name__}")
        func()

    return warp


def execute():
    print("nice")


def execute2():
    print("nice2")


if __name__ == "__main__":
    # print_func_name(execute)
    a = print_func_name(execute)
    b = print_func_name(execute2)
    a()
    b()
"""

########################################################

# Basic decorator

"""
def print_func_name(func):
    def warp():
        print(f"The function name is {func.__name__}")
        func()

    return warp


@print_func_name
def execute():
    print("nice")


@print_func_name
def execute2():
    print("nice2")


@print_func_name
def execute2():
    print("nice2")


if __name__ == "__main__":
    # print_func_name(execute)()
    execute()
    execute2()
"""

########################################################
# Multi decorator

"""
def print_func_hash_code(func):
    def warp():
        print(f"The function hash code is {func.__hash__()}")
        func()

    return warp


def print_func_name(func):
    def warp():
        print(f"The function name is {func.__name__}")
        func()

    return warp


@print_func_hash_code
@print_func_name
def execute():
    print("nice")


if __name__ == "__main__":
    execute()
"""


########################################################
# Decorator with parameter

"""
def print_func_with_param(param):
    def decorator(func):
        def wrap():
            print(f"The function name is {func.__name__}, parameter is {param}")
            func()

        return wrap

    return decorator


@print_func_with_param("nice")
def execute():
    print("Main execute")


if __name__ == "__main__":
    execute()
"""


####
"""
練習題:
在yahoo_finance的func中加入驗證的裝飾器, 驗證內容為輸入正確的帳號密碼(input)
帳號密碼自行定義, 要驗證通過才能取response值
# """


def login(func):
    def warp(*args, **kwargs):
        username, password = input("您的帳號為："), input("您的密碼為：")
        if username == os.getenv("AM_ACCOUNT") and password == os.getenv("AM_PASSWORD"):
            return func(*args, **kwargs)
        else:
            print("帳號密碼登入失敗")

    return warp


@login
def execute(num):
    print(num**2)


if __name__ == "__main__":
    load_dotenv()
    execute(2)
```

inheritance
```
class Animal:
    def __init__(self):
        self.legs = 4
        self.eyes = 2

    def eat(self):
        print("i am eating.")


class Dog(Animal):

    def __init__(self):
        super().__init__()
        self.tail = 1

    def eat(self):
        super().eat()
        print("i am eating dog food.")

    def barking(self):
        print("WOW")


if __name__ == "__main__":
    john = Dog()
    # john.eat()
    print(f"tail: {john.tail}")
    print(f"legs: {john.legs}")
    print(f"eyes: {john.eyes}")
```

enumerate
```
# enumerate() 函数用于将一个可遍历的数据对象(如列表、元组或字符串)组合为一个索引序列，同时列出数据和数据下标，一般用在 for 循环当中。

a = ["a", "b", "c"]
# b = (2,3,4)
# c = dict(a = 1, b = 2, c = 3)
# c = {"a": 1, "b": 2, "c": 3}


print(enumerate(a))
for index, value in enumerate(a):
    print(f"index: {index}, value: {value}")
```


### 下半堂

![image](https://hackmd.io/_uploads/BJjk7v_nT.png)


API
app.py
```
from flask import Flask
from flask_restful import Api
from apispec import APISpec
from apispec.ext.marshmallow import MarshmallowPlugin
from flask_apispec.extension import FlaskApiSpec
from flask_jwt_extended import JWTManager

from user.user import Users, User, Login

app = Flask(__name__)
app.config["DEBUG"] = True
app.config["JWT_SECRET_KEY"] = "secret_key"  # JWT token setting


app.config.update(
    {
        "APISPEC_SPEC": APISpec(
            title="Awesome Project",
            version="v1",
            plugins=[MarshmallowPlugin()],
            openapi_version="2.0.0",
            # Swagger setting to set authorization
            securityDefinitions={
                "bearer": {
                    "type": "apiKey",
                    "in": "header",
                    "name": "Authorization",
                }
            },
        ),
        "APISPEC_SWAGGER_URL": "/swagger/",  # URI to access API Doc JSON
        "APISPEC_SWAGGER_UI_URL": "/swagger-ui/",  # URI to access UI of API Doc
    }
)
docs = FlaskApiSpec(app)

api = Api(app)


api.add_resource(Users, "/users")
docs.register(Users)
api.add_resource(User, "/users/<int:id>")
docs.register(User)
api.add_resource(Login, "/login")
docs.register(Login)


if __name__ == "__main__":
    # Remembet to initial JWTManger before running app
    jwt = JWTManager().init_app(app)
    app.run(host="127.0.0.1", port=10011, debug=True)

```

user/user.py
```python=
import json
from flask import jsonify
from flask_restful import Resource, reqparse
import util
from . import user_router_model

import pymysql
from flask_jwt_extended import create_access_token, jwt_required
from flask_apispec import MethodResource, marshal_with, doc, use_kwargs
from datetime import timedelta


def db_init():
    db = pymysql.connect(
        host="127.0.0.1", user="root", password="root", port=8889, db="user"
    )
    cursor = db.cursor(pymysql.cursors.DictCursor)
    return db, cursor


def get_access_token(user):
    token = create_access_token(
        identity={"user": user}, expires_delta=timedelta(days=1)
    )
    return token

# Swagger setting for auto bring token in API
security_params = [{"bearer": []}]


class Login(MethodResource):
    @doc(description="login API", tags=["Login"])
    @use_kwargs(user_router_model.LoginSchema, location="form")
    @marshal_with(user_router_model.LoginResponse, code=200)
    def post(self, **kwargs):
        db, cursor = db_init()
        account = kwargs["account"]
        sql = f"SELECT * FROM test.user WHERE name = '{account}';"
        cursor.execute(sql)
        user = cursor.fetchall()
        db.close()

        if user != ():
            token = get_access_token(account)
            return util.success({"token": token})

        return util.failure()


class Users(MethodResource):
    # Get all User
    @doc(description="Get Users info.", tags=["Users"])
    @use_kwargs(user_router_model.UserGetSchema, location="query")
    @marshal_with(user_router_model.UserGetResponse, code=200)
    def get(self, **kwargs):
        db, cursor = db_init()

        name = kwargs.get("name")

        if name is not None:
            sql = f"SELECT * FROM test.user WHERE name LIKE '%{name}%';"
        else:
            sql = "SELECT * FROM test.user;"

        cursor.execute(sql)
        users = cursor.fetchall()
        db.close()
        return util.success(users)

    # Create User
    @doc(description="Create User.", tags=["User"], security=security_params)
    @use_kwargs(user_router_model.UserPostSchema, location="form")
    @marshal_with(user_router_model.UserCommonResponse, code=200)
    @jwt_required()
    def post(self, **kwargs):
        db, cursor = db_init()

        sql = """

        INSERT INTO `test`.`user` (`name`,`gender`,`birth`,`note`)
        VALUES ('{}','{}','{}','{}');

        """.format(
            kwargs["name"], kwargs["gender"], kwargs["birth"], kwargs["note"]
        )

        result = cursor.execute(sql)

        db.commit()
        db.close()

        if result == 0:
            return util.failure()

        return util.success()


class User(MethodResource):
    @doc(description="Get Single user info.", tags=["User"])
    @marshal_with(user_router_model.UserGetResponse, code=200)
    def get(self, id):
        db, cursor = db_init()
        sql = f"SELECT * FROM test.user WHERE id = '{id}';"
        cursor.execute(sql)
        users = cursor.fetchall()
        db.close()
        return util.success(users)

    @doc(description="Update User info.", tags=["User"], security=security_params)
    @use_kwargs(user_router_model.UserPatchSchema, location="form")
    @marshal_with(user_router_model.UserCommonResponse, code=201)
    @jwt_required()
    def patch(self, id, **kwargs):
        db, cursor = db_init()
        user = {
            "name": kwargs.get("name"),
            "gender": kwargs.get("gender"),
            "birth": kwargs.get("birth") or "1900-01-01",
            "note": kwargs.get("note"),
        }

        query = []
        for key, value in user.items():
            if value is not None:
                query.append(f"{key} = '{value}'")
        query = ",".join(query)

        sql = """
            UPDATE `test`.`user`
            SET {}
            WHERE id = {};
        """.format(
            query, id
        )

        result = cursor.execute(sql)
        db.commit()
        db.close()
        if result == 0:
            return util.failure()

        return util.success()

    @doc(description="Delete User info.", tags=["User"], security=security_params)
    @marshal_with(None, code=204)
    @jwt_required()
    def delete(self, id):
        db, cursor = db_init()
        sql = f"DELETE FROM `test`.`user` WHERE id = {id};"
        cursor.execute(sql)
        db.commit()
        db.close()


```

util.py
``` 
from datetime import datetime
from typing import Any


def success(data: Any = None) -> tuple[dict, int]:
    if data is None:
        return {"message": "success"}, 200
    return {
        "message": "success",
        "data": data,
        "datetime": datetime.utcnow().isoformat(),
    }, 200


def failure() -> tuple[dict, int]:
    return {"message": "failure"}, 500
```

user/user_router_model.py
```python=
from marshmallow import Schema, fields


# Schema
class LoginSchema(Schema):
    account = fields.Str(doc="account", example="string", required=True)


class UserGetSchema(Schema):
    name = fields.Str(example="string")


class UserPostSchema(Schema):
    name = fields.Str(doc="name", example="string", required=True)
    gender = fields.Str(doc="gender", example="string", required=True)
    birth = fields.Str(doc="birth", example="string", required=True)
    note = fields.Str(doc="note", example="string", required=True)


class UserPatchSchema(Schema):
    name = fields.Str(doc="name", example="string")
    gender = fields.Str(doc="gender", example="string")
    birth = fields.Str(doc="birth", example="string")
    note = fields.Str(doc="note", example="string")


# Response
class UserGetResponse(Schema):
    message = fields.Str(example="success")
    datetime = fields.Str(example="1970-01-01T00:00:00.000000")
    data = fields.List(fields.Dict())


class UserCommonResponse(Schema):
    message = fields.Str(example="success")


class LoginResponse(Schema):
    message = fields.Str(example="success")
    datetime = fields.Str(example="1970-01-01T00:00:00.000000")
    data = fields.Dict()

```


