# 2024/2/23 API

[2024/2/25 API](https://hackmd.io/@RbzcaEsXR-Grol5FvhwJYw/ByeIFEvh6)

---


## Q&A
Q:虛擬機的服務有辦法連到宿主機的服務嗎？
A:其實可以，但只要能設定相對應的網路模式就能連結，但會相對麻煩，建議還是講主要服務放在主機上，次要服務放置虛擬機中，或是全部放在同一個環境中。

## 網址
- [windows下載python](https://phoenixnap.com/kb/how-to-install-python-3-windows)
- [.env 設定環境變數](https://dev.to/emma_donery/python-dotenv-keep-your-secrets-safe-4ocn)
- [python annotation(註解)](https://mozillazg.com/2016/01/python-function-argument-type-check-base-on-function-annotations.html)
- [flask官方文件](https://flask.palletsprojects.com/en/2.1.x/quickstart/)
- [建立pyenv 與 virutalenv](https://www.maxlist.xyz/2020/04/01/python-pyenv-virtualenv/)
- [HY100 mysql connect socket error](https://stackoverflow.com/questions/11657829/error-2002-hy000-cant-connect-to-local-mysql-server-through-socket-var-run)



## 大綱
- 描述API基礎知識
- Yahoo finance API串接
- 基本API設計

## 需預先下載的軟體
- [Vscode](https://code.visualstudio.com/download)
- [Postman](https://www.postman.com/downloads/)
- Python3.10
    - python-dotenv==1.0.1
    - requests==2.31.0
    - Flask-JWT-Extended==4.4.1
    - Flask==2.1.2
    - Flask-RESTful == 0.3.9
    - PyMySQL==1.0.3
    - Werkzeug==2.2.2
- MySQLDB server, 可以用自己習慣的方式下載, 也可以使用 [MAMP](https://www.mamp.info/en/downloads/) 來驅動



## 上課會用到網頁
- [Yahoo finace API](https://financeapi.net/dashboard)
- [ChatGPT](https://chat.openai.com/)
- [Fake API website](https://jsonplaceholder.typicode.com/)
- [下載window MySQl](https://chwang12341.medium.com/mysql-%E5%AD%B8%E7%BF%92%E7%AD%86%E8%A8%98-%E4%BA%8C-%E4%B8%80%E5%88%86%E9%90%98%E8%BC%95%E9%AC%86%E7%9E%AD%E8%A7%A3%E5%A6%82%E4%BD%95%E5%9C%A8windows%E4%B8%8A%E5%AE%89%E8%A3%9Dmysql-63cce07c6a6c)
    - `


## 上半堂
    
### 練習1
```
import requests
from datetime import datetime
from dotenv import load_dotenv
import os

"""
透過"https://yfapi.net/v8/finance/spark"這隻API
取得AAPL, TSLA為期一個月且間格為一天的股價, 並整理成下方資料格式
{
    "AAPL": {
        "2021/12/21": "216.5",
        "2021/12/21": "216.5",
        "2021/12/21": "216.5",
        "2021/12/21": "216.5"
    },
    "TSLA": {
        "2021/12/21": "216.5",
        "2021/12/21": "216.5",
        "2021/12/21": "216.5",
        "2021/12/21": "216.5"
    }
}
"""

"""
Steps:
1. 將timestamp轉換成datetime(2021/12/21)
2. 將轉換過的timestamp_list 與close的price list合成上放的dict
3. 將股票代號設為key, value為整理過後的dict並return.
"""


def get_raw_data_from_yahoo_finance(symbols: str) -> dict:
    """
    Args:
        symbols(str): split with comma, ex: "AAPL,MSFT"
    """
    url = "https://yfapi.net/v8/finance/spark"
    querystring = {"symbols": symbols, "interval": "1d", "range": "1mo"}
    headers = {"x-api-key": os.getenv("API_KEY")}
    response = requests.request("GET", url, headers=headers, params=querystring)
    return response.json()


def convert_timestamp_to_datetime(timestamps: list[int]) -> list[str]:
    for index, timestamp in enumerate(timestamps):
        timestamps[index] = datetime.fromtimestamp(timestamp).strftime("%Y/%m/%d")
    return timestamps


def merge_two_list_to_dict(fir_list: list[str], sec_list: list[float]) -> dict:
    new_dict = dict(zip(fir_list, sec_list))
    return new_dict


def get_stock_history(symbols: str) -> dict:
    """
    Args:
        symbols(str): split with comma, ex: "AAPL,MSFT"
    """
    ret = {}
    results = get_raw_data_from_yahoo_finance(symbols)

    for symbol in symbols.split(","):
        timestamps = results[symbol]["timestamp"]
        timestamps = convert_timestamp_to_datetime(timestamps)
        close_piece = results[symbol]["close"]
        symbol_info_mapping = merge_two_list_to_dict(timestamps, close_piece)
        ret[symbol] = symbol_info_mapping

    return ret


if __name__ == "__main__":
    # 使用load_dotenv的時候記得把 .env的環境變數建立出來
    load_dotenv()
    ret = get_stock_history("AAPL,MSFT")
    print(ret)
```

## 下半堂

### Postman的使用方法
Postman為一個測試API的軟體, 會用在開發者開發完API後進行測試

Method - [GET]
- 將 請求的 參數放到Params(parameter)
- 放入的參數會呈現在route之後
![image](https://hackmd.io/_uploads/ry1qbVDhp.png)


Method - [Post]
- 將 請求的 參數放到Body之中 
- 可選擇form-datas 或是 json 取決於API的設計
- 需自行填入

![image](https://hackmd.io/_uploads/HycyMNP2p.png)


Testing
- 支援js語法
- 可透過旁邊的範例(snippets下面)點擊會自行加入
![image](https://hackmd.io/_uploads/SkCUI2S26.png)

Env
- 可多人共用
- 會將重複用的值設定成環境變數放在此 e.g base_url / user_id 等等
- Initial value：此變數的初始值(建立後就不能變動)
- Current value: 此變數現在的值(可隨意變動, 若沒特別設定會以initial value為主)
![image](https://hackmd.io/_uploads/rkDO83BhT.png)


### Flask basic
### app.py
```
from flask import Flask

app = Flask(__name__)


@app.route("/")
def hello_world():
    return "<p>Hello, World!</p>"


if __name__ == "__main__":
    app.run(host="127.0.0.1", port=10009, debug=True)
```

## 建立DB table

id: int (PK) AUTO
name: varchar
gender: varchar
birth: varchar
note: varchar

![image](https://hackmd.io/_uploads/HJdXw6rna.png)



![image](https://hackmd.io/_uploads/Hk3hkRrna.png)

user/user.py
``` 
import json
from flask import jsonify
from flask_restful import Resource, reqparse
import pymysql


def db_init():
    db = pymysql.connect(
        host="127.0.0.1", user="root", password="root", port=8889, db="user"
    )
    cursor = db.cursor(pymysql.cursors.DictCursor)
    return db, cursor


class Users(Resource):
    # Get all User
    def get(self):
        db, cursor = db_init()
        sql = "SELECT * FROM test.user;"

        cursor.execute(sql)
        users = cursor.fetchall()
        db.close()
        return jsonify(users)
        
    def post(self):
        db, cursor = db_init()
        
        parser = reqparse.RequestParser()
        parser.add_argument("name", type=str, required=True, location="form")
        parser.add_argument("gender", type=str, required=True, location="form")
        parser.add_argument("birth", type=str, required=True, location="form")
        parser.add_argument("note", type=str, location="form")

        args = parser.parse_args()
        user = {
            "name": args["name"],
            "gender": args["gender"],
            "birth": args.get("birth") or "1900-01-01",
            "note": args.get("note"),
        }
        sql = """

        INSERT INTO `test`.`user` (`name`,`gender`,`birth`,`note`)
        VALUES ('{}','{}','{}','{}');

        """.format(
            user["name"], user["gender"], user["birth"], user["note"]
        )
        result = cursor.execute(sql)
        message = "success" if result == 1 else "failure"
        db.commit()
        db.close()

        return jsonify({"message": message})


class User(Resource):
    def delete(self, id):
        db, cursor = db_init()
        sql = f"DELETE FROM `test`.`user` WHERE id = {id};"
        result = cursor.execute(sql)
        message = "success" if result == 1 else "failure"
        db.commit()
        db.close()

        return jsonify({"message": message})



```

app.py
```
from flask import Flask
from flask_restful import Api

from user.user import Users, User

app = Flask(__name__)
app.config["DEBUG"] = True
api = Api(app)



api.add_resource(Users, "/users")
api.add_resource(User, "/users/<int:id>")


if __name__ == "__main__":
    app.run(host="127.0.0.1", port=10010, debug=True)

```

---

```
 GRANT ALL 
 ON *.* 
 TO 'admin'@'localhost' 
 IDENTIFIED BY '123456'
 WITH GRANT OPTION;
```

